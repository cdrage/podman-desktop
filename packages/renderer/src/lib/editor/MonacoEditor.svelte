<script lang="ts">
import { onDestroy, onMount } from 'svelte';
import editorWorker from 'monaco-editor/esm/vs/editor/editor.worker?worker';
import jsonWorker from 'monaco-editor/esm/vs/language/json/json.worker?worker';
import { EditorSettings } from '../../../../main/src/plugin/editor-settings';

import type monaco from 'monaco-editor';
import { getPanelDetailColor } from '../color/color';
import { PlaceholderContentWidget } from './placeholder-widget';

let divEl: HTMLDivElement;
let editor: monaco.editor.IStandaloneCodeEditor;
let Monaco;

export let content = '';
export let language = 'json';
export let readOnly = true;

// Add "default" text that will show if the content is blank
// once typing occurs it'll clear.
export let defaultText = '';

onMount(async () => {
  self.MonacoEnvironment = {
    getWorker: function (_moduleId: any, label: string) {
      if (label === 'json') {
        return new jsonWorker();
      }
      return new editorWorker();
    },
    createTrustedTypesPolicy: () => undefined,
  };

  Monaco = await import('monaco-editor');

  // grab font size
  const fontSize = await window.getConfigurationValue<number>(
    EditorSettings.SectionName + '.' + EditorSettings.FontSize,
  );

  Monaco.editor.defineTheme('podmanDesktopTheme', {
    base: 'vs-dark',
    inherit: true,
    rules: [{ token: 'custom-color', background: getPanelDetailColor() }],
    colors: {
      'editor.background': getPanelDetailColor(),
    },
  });

  editor = Monaco.editor.create(divEl, {
    value: content,
    fontSize,
    language,
    readOnly: readOnly,
    theme: 'podmanDesktopTheme',
    automaticLayout: true,
    scrollBeyondLastLine: false,
  });

  // If the content passed in is blank and there is default text, create the "placeholder widget"
  // using a custom class that will show the default text and remove it when the user starts typing
  if (content === '' && defaultText !== '') {
    new PlaceholderContentWidget(defaultText, editor);
  }
});

onDestroy(() => {
  editor?.dispose();
});

$: content, editor?.getModel()?.setValue(content);
</script>

<div bind:this="{divEl}" class="h-full"></div>
